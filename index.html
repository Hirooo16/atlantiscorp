<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATLANTIS CORP - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&family=Material+Icons" rel="stylesheet" />
  <style>
    /* Deep Sea Dark Theme Styles */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #002538 0%, #004661 100%);
      color: #cce7ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      background-color: #003551;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid #006280;
      user-select: none;
      z-index: 1000;
    }
    header h1 {
      font-weight: 800;
      font-size: 1.6rem;
      color: #70c9f9;
    }
    header button {
      background: #0077b6;
      color: #d0f0fd;
      border: none;
      padding: 8px 20px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    header button:hover {
      background-color: #0096c7;
    }
    main {
      display: flex;
      flex: 1 1 auto;
      overflow: hidden;
      position: relative;
      z-index: 0;
    }
    /* Sidebar Navigation */
    nav.side-menu {
      width: 280px;
      background-color: #004c73;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 2px solid #006280;
      z-index: 0;
    }
    nav.side-menu h2 {
      margin: 0 0 16px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #a3d2f3;
      user-select: none;
      border-bottom: 1px solid #006280;
      padding-bottom: 12px;
    }
    nav.side-menu button {
      background: transparent;
      border: none;
      color: #cce7ff;
      font-size: 1rem;
      font-weight: 600;
      padding: 12px 8px;
      text-align: left;
      cursor: pointer;
      border-radius: 10px;
      margin-bottom: 12px;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    nav.side-menu button.active,
    nav.side-menu button:hover {
      background-color: #0077b6;
      color: #f0f9ff;
      font-weight: 700;
    }
    /* Content area */
    section.content-area {
      flex: 1 1 auto;
      position: relative;
      overflow-y: auto;
      padding: 24px;
      background: #003347;
      border-left: 2px solid #006280;
      display: flex;
      flex-direction: column;
      z-index: 0;
    }
    section.content-area > h2 {
      margin-top: 0;
      font-weight: 800;
      font-size: 1.8rem;
      color: #8ed0f9;
      user-select: none;
    }
    /* Filter container styling */
    #filter-container {
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      max-width: 800px;
    }
    #filter-input {
      flex: 1 1 240px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #0077b6;
      background-color: #005a7c;
      color: #d6eafc;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      outline-offset: 2px;
      outline-color: #55aaff;
      transition: border-color 0.3s ease;
    }
    #filter-input::placeholder {
      color: #a0c5ef;
    }
    #filter-clear-btn {
      background-color: #0096c7;
      color: #d0f0fd;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #filter-clear-btn:hover {
      background-color: #00b0ff;
    }
    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.95rem;
    }
    thead {
      background-color: #005b8c;
    }
    thead th {
      padding: 10px 12px;
      text-align: left;
      color: #c7e0ff;
      border-bottom: 2px solid #0077b6;
      user-select: none;
    }
    tbody tr:nth-child(odd) {
      background-color: #00485a;
    }
    tbody tr:nth-child(even) {
      background-color: #005b7b;
    }
    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid #006ba6;
      color: #cce7ff;
      vertical-align: middle;
      max-width: 220px;
      word-break: break-word;
      white-space: normal;
    }
    tbody tr:hover {
      background-color: #0077b6;
      cursor: default;
    }
    /* Buttons in tables */
    button.action-btn {
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      background-color: #0077b6;
      color: #d0f0fd;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.action-btn:hover:not(:disabled) {
      background-color: #0096c7;
    }
    button.action-btn:disabled {
      background-color: #00465a;
      cursor: not-allowed;
    }
    /* Forms for Add and Update */
    form.item-form {
      max-width: 680px;
      background-color: #00455a;
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 40px;
      box-shadow: 0 0 20px rgba(0,110,160,0.6);
      color: #cde6f1;
    }
    form.item-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      user-select: none;
    }
    form.item-form input[type="text"],
    form.item-form input[type="number"],
    form.item-form textarea,
    form.item-form select {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 1px solid #0077b6;
      background-color: #005a7c;
      color: #d6eafc;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      resize: vertical;
      outline-offset: 2px;
      outline-color: #55aaff;
      transition: border-color 0.3s ease;
    }
    form.item-form input[type="file"] {
      margin-top: 6px;
      margin-bottom: 20px;
      color: #cce7ff;
    }
    form.item-form input[type="text"]:focus,
    form.item-form input[type="number"]:focus,
    form.item-form textarea:focus,
    form.item-form select:focus {
      border-color: #55aaff;
      background-color: #006791;
    }
    form.item-form button {
      background-color: #0096c7;
      color: #d0f0fd;
      border: none;
      padding: 12px 28px;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
      font-size: 1rem;
      min-height: 44px;
      min-width: 120px;
    }
    form.item-form button:hover:not(:disabled) {
      background-color: #00b0ff;
    }
    form.item-form button:disabled {
      background-color: #005b81;
      cursor: not-allowed;
    }
    /* Image preview styling */
    .image-preview {
      margin-bottom: 16px;
      border-radius: 12px;
      max-width: 180px;
      max-height: 140px;
      object-fit: contain;
      border: 1px solid #0077b6;
      box-shadow: 0 0 8px rgba(0, 127, 255, 0.4);
      user-select: none;
    }
    /* Professional Floating Chatbox */
    #chat-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 360px;
      max-height: 56px;
      background-color: #003f61;
      border-radius: 28px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.4s, padding 0.4s;
      padding: 0;
      display: flex;
      flex-direction: column;
      z-index: 2000;
      font-size: 1rem;
      user-select: none;
      font-synthesis: none;
      will-change: max-height, padding;
    }
    #chat-container.active {
      max-height: 480px;
      padding: 20px 22px 24px 22px;
      width: 380px;
      border-radius: 20px;
    }
    #chat-header {
      font-weight: 700;
      font-size: 1.45rem;
      color: #85d2ff;
      background-color: #004f7a;
      border-radius: 28px;
      padding: 14px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      box-shadow: 0 0 14px rgba(7, 52, 91, 0.8);
      user-select: none;
    }
    #chat-header .title-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-grow: 1;
    }
    #chat-header .material-icons {
      font-size: 32px;
      color: #55aaff;
      user-select: none;
      flex-shrink: 0;
    }
    #chat-toggle-btn {
      background: transparent;
      border: none;
      color: #85d2ff;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      margin: 0;
      user-select: none;
      transition: color 0.3s ease;
      flex-shrink: 0;
    }
    #chat-toggle-btn:hover {
      color: #aad8ff;
    }
    #messages-list {
      flex: 1 1 auto;
      overflow-y: auto;
      background-color: #00557a;
      padding: 14px 18px;
      margin-top: 16px;
      border-radius: 14px;
      border: 1px solid #0072bb;
      color: #cbe9ff;
      font-size: 0.95rem;
      line-height: 1.4;
      display: none;
      user-select: text;
      -webkit-font-smoothing: antialiased;
      scrollbar-width: thin;
      scrollbar-color: #55aaff #003b59;
    }
    #chat-container.active #messages-list {
      display: block;
    }
    #messages-list::-webkit-scrollbar {
      width: 8px;
    }
    #messages-list::-webkit-scrollbar-thumb {
      background-color: #55aaff;
      border-radius: 5px;
      border: 2px solid #003b59;
    }
    .chat-message {
      margin-bottom: 16px;
      padding: 12px 18px;
      border-radius: 18px;
      max-width: 78%;
      word-wrap: break-word;
      background-color: #0070b1;
      position: relative;
      user-select: text;
      font-weight: 500;
      letter-spacing: 0.02em;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease;
    }
    .chat-message:hover {
      background-color: #005f8d;
    }
    .chat-message.self {
      margin-left: auto;
      background-color: #0099f7;
      color: #001f35;
      font-weight: 700;
      box-shadow: 0 2px 12px rgba(0, 149, 255, 0.6);
    }
    .chat-message .meta {
      font-size: 0.75rem;
      color: #a6c9f4;
      margin-top: 8px;
      text-align: right;
      font-style: italic;
      user-select: none;
    }
    #chat-input-container {
      margin-top: 18px;
      display: none;
      gap: 14px;
      user-select: auto;
    }
    #chat-container.active #chat-input-container {
      display: flex;
    }
    #chat-input {
      flex: 1 1 auto;
      border-radius: 24px;
      border: none;
      padding: 14px 22px;
      font-size: 1.05rem;
      font-family: 'Inter', sans-serif;
      resize: none;
      min-height: 56px;
      max-height: 120px;
      outline-offset: 3px;
      outline-color: #55aaff;
      background-color: #005679;
      color: #d1e8ff;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }
    #chat-input::placeholder {
      color: #a8c8f2;
      font-weight: 400;
      letter-spacing: 0.02em;
    }
    #chat-input:focus {
      background-color: #006995;
      box-shadow: inset 0 3px 8px rgba(0,0,0,0.5);
    }
    #chat-send-btn {
      background-color: #007ddb;
      color: #e2f0ff;
      border: none;
      border-radius: 24px;
      padding: 14px 30px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.25s ease;
      min-height: 56px;
      min-width: 110px;
      box-shadow: 0 2px 8px rgba(0,120,210,0.8);
      flex-shrink: 0;
    }
    #chat-send-btn:disabled {
      background-color: #004f79;
      cursor: not-allowed;
      box-shadow: none;
    }
    #chat-send-btn:hover:not(:disabled) {
      background-color: #008fff;
      box-shadow: 0 3px 12px rgba(0,143,255,0.9);
    }
    /* Responsive */
    @media (max-width: 1100px) {
      nav.side-menu {
        width: 220px;
        padding: 20px 12px;
      }
      section.content-area {
        padding: 16px 18px;
      }
    }
    @media (max-width: 768px) {
      main {
        flex-direction: column;
        overflow: auto;
      }
      nav.side-menu {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #006280;
        flex-direction: row;
        padding: 12px;
        gap: 8px;
        overflow-x: auto;
      }
      nav.side-menu button {
        flex: none;
        margin-bottom: 0;
        padding: 10px 14px;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      section.content-area {
        border-left: none;
        padding: 16px 12px;
      }
      #chat-container {
        width: 280px;
        right: 16px;
        bottom: 24px;
        top: auto;
        max-height: 48px;
        padding: 0;
        border-radius: 28px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      #chat-container.active {
        max-height: 480px;
        width: 320px;
        padding: 16px 20px 20px 20px;
        border-radius: 16px;
      }
      #chat-header {
        font-size: 1.6rem;
        min-height: 48px;
        padding: 12px 16px;
      }
      #chat-header .material-icons {
        font-size: 28px;
      }
      #chat-input {
        min-height: 48px;
        font-size: 1rem;
        padding: 12px 14px;
      }
      #chat-send-btn {
        padding: 12px 26px;
        min-height: 48px;
        min-width: 90px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <header role="banner" aria-label="Header ATLANTIS CORP">
    <h1>ATLANTIS CORP</h1>
    <button id="logout-btn" aria-label="Keluar dari akun">Logout</button>
  </header>

  <main role="main">
    <nav class="side-menu" aria-label="Navigasi utama">
      <h2>Menu</h2>
      <button id="btn-dashboard" class="active" aria-pressed="true" aria-controls="dashboard-section" role="tab">Dashboard</button>
      <button id="btn-update" aria-pressed="false" aria-controls="update-section" role="tab">Update Barang</button>
      <button id="btn-create" aria-pressed="false" aria-controls="create-section" role="tab">Tambah Barang Baru</button>
    </nav>

    <section class="content-area" tabindex="0">
      <h2>Dashboard - Stok Barang</h2>

      <div id="filter-container">
        <input type="text" id="filter-input" placeholder="Cari Jenis Barang..." aria-label="Filter cari jenis barang" autocomplete="off" />
        <button id="filter-clear-btn" aria-label="Reset filter">Reset</button>
      </div>

      <!-- Aqua Tech Section -->
      <section aria-labelledby="aqua-tech-title">
        <h3 id="aqua-tech-title">Aqua Tech (Perangkat IT)</h3>
        <table aria-describedby="desc-aqua-tech">
          <caption id="desc-aqua-tech">Daftar barang perangkat IT seperti laptop, tablet, hp, monitor</caption>
          <thead>
            <tr>
              <th>Kode Barang</th>
              <th>Jenis Barang</th>
              <th>Model/Merk</th>
              <th>Serial Number</th>
              <th>Spesifikasi</th>
              <th>Harga Beli</th>
              <th>Status</th>
              <th>PIC</th>
              <th>Gambar</th>
            </tr>
          </thead>
          <tbody id="aqua-tech-table-body">
            <tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Aqua Threads Section -->
      <section style="margin-top: 40px;" aria-labelledby="aqua-threads-title">
        <h3 id="aqua-threads-title">Aqua Threads (Penjualan Kaos)</h3>
        <table aria-describedby="desc-aqua-threads">
          <caption id="desc-aqua-threads">Daftar kaos yang dijual</caption>
          <thead>
            <tr>
              <th>Kode Barang</th>
              <th>Jenis Barang</th>
              <th>Model/Merk</th>
              <th>Serial Number</th>
              <th>Spesifikasi</th>
              <th>Harga Beli</th>
              <th>Status</th>
              <th>PIC</th>
              <th>Gambar</th>
            </tr>
          </thead>
          <tbody id="aqua-threads-table-body">
            <tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>
          </tbody>
        </table>
      </section>

      <button id="download-data-btn" style="margin-top:32px; padding:12px 28px; font-weight: 700; border-radius:14px; cursor:pointer; border:none; background:#0096c7; color:#ccefff; user-select:none;">Download Semua Data (Excel)</button>
    </section>

    <section id="update-section" role="tabpanel" aria-labelledby="btn-update" hidden>
      <!-- Update status section unchanged -->
      <h2>Update Status Barang</h2>
      <section aria-label="Pilih barang yang ingin diupdate" style="max-width:720px;">
        <label for="update-select">Pilih barang:</label>
        <select id="update-select" aria-required="true" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #0077b6; background:#005a7c; color:#ccefff; margin-bottom:16px;"></select>
        <label for="update-status-select">Ubah status menjadi:</label>
        <select id="update-status-select" aria-required="true" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #0077b6; background:#005a7c; color:#ccefff; margin-bottom:22px;">
          <option value="stock">Stock</option>
          <option value="sold">Sudah Terjual</option>
          <option value="lost">Hilang</option>
        </select>
        <button id="update-item-btn" style="background:#00ace6; color:#e0f2ff; border:none; padding:14px 28px; border-radius:14px; font-weight:700; cursor:pointer; user-select:none;">Update Status</button>
      </section>
    </section>

    <section id="create-section" role="tabpanel" aria-labelledby="btn-create" hidden>
      <!-- Create new item form unchanged -->
      <h2>Tambah Barang Baru</h2>
      <form id="create-form" class="item-form" aria-label="Formulir tambah barang">
        <label for="create-category">Pilih Kategori Barang:</label>
        <select id="create-category" required>
          <option value="" disabled selected>Pilih Aqua Tech atau Aqua Threads</option>
          <option value="aqua-tech">Aqua Tech (Perangkat IT)</option>
          <option value="aqua-threads">Aqua Threads (Kaos)</option>
        </select>
        <label for="create-type">Jenis Barang:</label>
        <input type="text" id="create-type" placeholder="Contoh: Laptop, Kaos" required />
        <label for="create-model">Model / Merk:</label>
        <input type="text" id="create-model" placeholder="Contoh: Dell XPS 13, Kaos Merk X" required />
        <label for="create-serial">Serial Number:</label>
        <input type="text" id="create-serial" placeholder="Nomor Serial" required />
        <label for="create-specs">Detail Spesifikasi:</label>
        <textarea id="create-specs" rows="4" placeholder="RAM, Prosesor, Memory, VGA, dll" required></textarea>
        <label for="create-price">Harga Beli (Rp):</label>
        <input type="number" id="create-price" min="0" step="1000" placeholder="0" required />
        <label for="create-pic">PIC Upload:</label>
        <input type="text" id="create-pic" placeholder="Nama PIC" required />
        <label for="create-image">Upload Gambar Barang (opsional, max 2MB):</label>
        <input type="file" id="create-image" accept="image/*" />
        <div id="preview-container" aria-live="polite" style="margin-bottom:20px;"></div>
        <button type="submit" id="create-submit-btn">Tambah Barang</button>
      </form>
    </section>

    <!-- Professional Floating Chatbox -->
    <aside id="chat-container" aria-label="Kotak chat admin" role="complementary">
      <div id="chat-header" tabindex="0" aria-pressed="false" role="button" aria-label="Toggle chat kotak">
        <div class="title-wrapper">
          <span class="material-icons" aria-hidden="true">chat_bubble</span>
          Chat Admin Real-Time
        </div>
        <button id="chat-toggle-btn" aria-label="Tutup/Tampilkan chat">
          <span class="material-icons">expand_less</span>
        </button>
      </div>
      <div id="messages-list" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
      <form id="chat-form" aria-label="Formulir kirim pesan chat" style="margin-top:16px; display: flex; gap: 8px;">
        <textarea id="chat-input" aria-label="Input pesan chat" placeholder="Ketik pesan..." rows="2" required style="flex:1; border-radius: 18px; border: none; padding: 10px 14px; font-family: 'Inter', sans-serif; resize: none; outline-offset: 2px; outline-color: #55aaff; background-color: #00557a; color: #ccefff;"></textarea>
        <button id="chat-send-btn" type="submit" disabled style="background-color: #008ce6; color: #cce7ff; border: none; border-radius: 18px; padding: 12px 20px; font-weight: 700; cursor: pointer; user-select: none;">Kirim</button>
      </form>
    </aside>
  </main>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBdKELW2FNsL7H1zB8R765czcDPaSYybdg",
  authDomain: "atlantis-store.firebaseapp.com",
  databaseURL: "https://atlantis-store-default-rtdb.firebaseio.com",
  projectId: "atlantis-store",
  storageBucket: "atlantis-store.appspot.com",
  messagingSenderId: "566295949160",
  appId: "1:566295949160:web:3ad8956c753d2f05a5f0dd",
  measurementId: "G-F5RG09TFCK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// Elements
const logoutBtn = document.getElementById('logout-btn');
const btnDashboard = document.getElementById('btn-dashboard');
const btnUpdate = document.getElementById('btn-update');
const btnCreate = document.getElementById('btn-create');
const dashboardSection = document.getElementById('dashboard-section');
const updateSection = document.getElementById('update-section');
const createSection = document.getElementById('create-section');
const aquaTechBody = document.getElementById('aqua-tech-table-body');
const aquaThreadsBody = document.getElementById('aqua-threads-table-body');
const downloadBtn = document.getElementById('download-data-btn');
const filterInput = document.getElementById('filter-input');
const filterClearBtn = document.getElementById('filter-clear-btn');
const updateSelect = document.getElementById('update-select');
const updateStatusSelect = document.getElementById('update-status-select');
const updateItemBtn = document.getElementById('update-item-btn');
const createForm = document.getElementById('create-form');
const createCategory = document.getElementById('create-category');
const createType = document.getElementById('create-type');
const createModel = document.getElementById('create-model');
const createSerial = document.getElementById('create-serial');
const createSpecs = document.getElementById('create-specs');
const createPrice = document.getElementById('create-price');
const createImage = document.getElementById('create-image');
const createPic = document.getElementById('create-pic');
const previewContainer = document.getElementById('preview-container');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send-btn');
const messagesList = document.getElementById('messages-list');
const chatHeader = document.getElementById('chat-header');
const chatToggleBtn = document.getElementById('chat-toggle-btn');

let chatActive = false;
let currentUser = null;
let itemsCache = {
  'aqua-tech': {},
  'aqua-threads': {}
};

function sanitize(str) {
  const temp = document.createElement('div');
  temp.textContent = str;
  return temp.innerHTML;
}

function sanitizePlain(str) {
  if(!str) return '';
  return str.toString().replace(/<[^>]*>/g, '').replace(/\n/g, ' ');
}

function generateItemCode() {
  const now = new Date();
  const pad = n => String(n).padStart(2, '0');
  const ymd = \`\${now.getFullYear()}\${pad(now.getMonth() + 1)}\${pad(now.getDate())}\${pad(now.getHours())}\${pad(now.getMinutes())}\${pad(now.getSeconds())}\`;
  const rand = Math.floor(Math.random() * 10000);
  return \`ATL-\${ymd}-\${rand.toString().padStart(4, '0')}\`;
}

function showAlert(msg) {
  alert(msg);
}

function showError(msg) {
  console.error(msg);
  showAlert(msg);
}

function activateTab(tabBtn) {
  [btnDashboard, btnUpdate, btnCreate].forEach(btn => {
    const isActive = (btn === tabBtn);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive.toString());
  });
  dashboardSection.hidden = (tabBtn !== btnDashboard);
  updateSection.hidden = (tabBtn !== btnUpdate);
  createSection.hidden = (tabBtn !== btnCreate);
  if (!dashboardSection.hidden) dashboardSection.focus();
  else if (!updateSection.hidden) updateSection.focus();
  else if (!createSection.hidden) createSection.focus();
}

btnDashboard.addEventListener('click', () => activateTab(btnDashboard));
btnUpdate.addEventListener('click', () => activateTab(btnUpdate));
btnCreate.addEventListener('click', () => activateTab(btnCreate));

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    loadAllDataRealtime();
    setupChatListener();
  } else {
    currentUser = null;
    window.location.href = "Login.html";
  }
});

logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

function loadAllDataRealtime() {
  itemsCache['aqua-tech'] = {};
  itemsCache['aqua-threads'] = {};
  aquaTechBody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>';
  aquaThreadsBody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>';
  updateSelect.innerHTML = '';
  database.ref('items/aqua-tech').on('value', snapshot => {
    const val = snapshot.val() || {};
    itemsCache['aqua-tech'] = val;
    renderItems('aqua-tech');
  });
  database.ref('items/aqua-threads').on('value', snapshot => {
    const val = snapshot.val() || {};
    itemsCache['aqua-threads'] = val;
    renderItems('aqua-threads');
  });
}

function renderItems(category) {
  const tbody = category === 'aqua-tech' ? aquaTechBody : aquaThreadsBody;
  const items = itemsCache[category];
  tbody.innerHTML = '';
  if (!items || Object.keys(items).length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Tidak ada data.</td></tr>';
    return;
  }
  const filterText = filterInput.value.trim().toLowerCase();
  Object.entries(items).forEach(([code, item]) => {
    if(filterText && !item.type.toLowerCase().includes(filterText)) return;
    const tr = document.createElement('tr');
    function addColumn(text) {
      const td = document.createElement('td');
      td.textContent = text;
      return td;
    }
    tr.appendChild(addColumn(code));
    tr.appendChild(addColumn(item.type));
    tr.appendChild(addColumn(item.model));
    tr.appendChild(addColumn(item.serial));
    tr.appendChild(addColumn(sanitizePlain(item.specs)));
    tr.appendChild(addColumn(\`Rp\${Number(item.price).toLocaleString('id-ID')}\`));
    let statusText = '';
    if(item.status === 'stock') statusText = 'Stock';
    else if(item.status === 'sold') statusText = 'Terjual';
    else if(item.status === 'lost') statusText = 'Hilang';
    else statusText = item.status || '';
    const statusTd = document.createElement('td');
    statusTd.textContent = statusText;
    if(statusText === 'Stock') {
      statusTd.style.color = '#4caf50';
      statusTd.style.fontWeight = '700';
    } else if(statusText === 'Terjual') {
      statusTd.style.color = '#f44336';
      statusTd.style.fontWeight = '700';
    } else if(statusText === 'Hilang') {
      statusTd.style.color = '#9e9e9e';
      statusTd.style.fontWeight = '700';
    }
    tr.appendChild(statusTd);
    tr.appendChild(addColumn(item.pic || 'Tidak ada PIC'));
    const tdImg = document.createElement('td');
    if(item.imageUrl) {
      const img = document.createElement('img');
      img.src = item.imageUrl;
      img.alt = \`Gambar \${item.type} - \${item.model}\`;
      img.className = 'image-preview';
      tdImg.appendChild(img);
    } else {
      tdImg.textContent = 'No Image';
      tdImg.style.color = '#789bb7';
    }
    tr.appendChild(tdImg);
    tbody.appendChild(tr);
  });
  populateUpdateSelectAll();
}

function populateUpdateSelectAll() {
  const allOptions = [];
  ['aqua-tech', 'aqua-threads'].forEach(category => {
    const items = itemsCache[category];
    if(!items) return;
    Object.entries(items).forEach(([code, item]) => {
      allOptions.push({
        code,
        label: \`[\${category.toUpperCase()}] \${code} - \${item.model}\`
      });
    });
  });
  updateSelect.innerHTML = '<option value="" disabled selected>Pilih barang yang akan diupdate</option>';
  allOptions.forEach(opt => {
    const optionElem = document.createElement('option');
    optionElem.value = opt.code;
    optionElem.textContent = opt.label;
    updateSelect.appendChild(optionElem);
  });
}

updateItemBtn.addEventListener('click', () => {
  const selectedCode = updateSelect.value;
  const newStatus = updateStatusSelect.value;
  if(!selectedCode) {
    showAlert('Pilih barang yang ingin diupdate statusnya.');
    return;
  }
  if(!newStatus) {
    showAlert('Pilih status baru.');
    return;
  }
  let foundCategory = null;
  if(itemsCache['aqua-tech'] && itemsCache['aqua-tech'][selectedCode]) foundCategory = 'aqua-tech';
  else if(itemsCache['aqua-threads'] && itemsCache['aqua-threads'][selectedCode]) foundCategory = 'aqua-threads';
  if(!foundCategory) {
    showAlert('Barang tidak ditemukan.');
    return;
  }
  database.ref(\`items/\${foundCategory}/\${selectedCode}/status\`).set(newStatus)
  .then(() => {
    showAlert(\`Status barang \${selectedCode} berhasil diupdate menjadi \${newStatus}.\`);
    updateSelect.value = '';
    updateStatusSelect.value = '';
  })
  .catch(err => {
    showError('Gagal update status: ' + err.message);
  });
});

createImage.addEventListener('change', () => {
  previewContainer.innerHTML = '';
  if(createImage.files.length === 0) return;
  const file = createImage.files[0];
  if(file.size > 2*1024*1024) {
    showAlert('Ukuran gambar maksimal 2 MB.');
    createImage.value = '';
    return;
  }
  const img = document.createElement('img');
  img.className = 'image-preview';
  img.alt = 'Preview Gambar Barang Baru';
  img.src = URL.createObjectURL(file);
  previewContainer.appendChild(img);
});

createForm.addEventListener('submit', e => {
  e.preventDefault();
  const category = createCategory.value;
  const type = createType.value.trim();
  const model = createModel.value.trim();
  const serial = createSerial.value.trim();
  const specs = createSpecs.value.trim();
  const priceRaw = createPrice.value.trim();
  const price = Number(priceRaw);
  const picValue = createPic.value.trim();
  if(!category || !type || !model || !serial || !specs || !priceRaw || isNaN(price) || price < 0 || !picValue) {
    showAlert('Mohon isi semua data dengan benar, termasuk PIC.');
    return;
  }
  const submitBtn = createForm.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Menyimpan...';
  const itemCode = generateItemCode();
  const newItem = {
    type,
    model,
    serial,
    specs,
    price,
    status: 'stock',
    imageUrl: null,
    createdAt: new Date().toISOString(),
    pic: picValue
  };
  if(createImage.files.length > 0) {
    const file = createImage.files[0];
    const ext = file.name.split('.').pop();
    const storageRef = storage.ref(\`item-images/\${itemCode}.\${ext}\`);
    storageRef.put(file)
      .then(snapshot => snapshot.ref.getDownloadURL())
      .then(downloadURL => {
        newItem.imageUrl = downloadURL;
        return database.ref(\`items/\${category}/\${itemCode}\`).set(newItem);
      })
      .then(() => {
        showAlert(\`Barang baru dengan kode \${itemCode} berhasil ditambahkan.\`);
        createForm.reset();
        previewContainer.innerHTML = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      })
      .catch(err => {
        showError('Gagal menambahkan barang: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      });
  } else {
    database.ref(\`items/\${category}/\${itemCode}\`).set(newItem)
      .then(() => {
        showAlert(\`Barang baru dengan kode \${itemCode} berhasil ditambahkan.\`);
        createForm.reset();
        previewContainer.innerHTML = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      })
      .catch(err => {
        showError('Gagal menambahkan barang: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      });
  }
});

downloadBtn.addEventListener('click', () => {
  const workbook = XLSX.utils.book_new();
  function addSheetFromItems(category, sheetName) {
    const items = itemsCache[category];
    if(!items) return;
    const rows = [];
    rows.push(['Kode Barang','Kategori','Jenis Barang','Model/Merk','Serial Number','Spesifikasi','Harga Beli (Rp)','Status','PIC','Tanggal Dibuat']);
    Object.entries(items).forEach(([code, item]) => {
      rows.push([
        code,
        category === 'aqua-tech' ? 'Aqua Tech' : 'Aqua Threads',
        item.type,
        item.model,
        item.serial,
        item.specs,
        item.price,
        item.status,
        item.pic || '',
        item.createdAt ? new Date(item.createdAt).toLocaleString('id-ID') : ''
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
  }
  addSheetFromItems('aqua-tech', 'AquaTech');
  addSheetFromItems('aqua-threads', 'AquaThreads');
  XLSX.writeFile(workbook, 'AtlantisCorp_DataBarang_'+new Date().toISOString().slice(0,10)+'.xlsx');
});

const chatRef = database.ref('chat/messages');

function addChatMessage(msg, isSelf) {
  const div = document.createElement('div');
  div.className = 'chat-message';
  if(isSelf) div.classList.add('self');
  div.textContent = msg.text;
  const meta = document.createElement('div');
  meta.className = 'meta';
  const time = new Date(msg.timestamp);
  meta.textContent = \`\${msg.senderName || 'Admin'} â€¢ \${time.toLocaleTimeString('id-ID')}\`;
  div.appendChild(meta);
  messagesList.appendChild(div);
  messagesList.scrollTop = messagesList.scrollHeight;
}

function setupChatListener(){
  chatRef.limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    if(!msg) return;
    addChatMessage(msg, currentUser && msg.senderId === currentUser.uid);
  });
}

chatHeader.addEventListener('click', () => {
  const chatContainer = document.getElementById('chat-container');
  chatActive = !chatActive;
  if(chatActive) {
    chatContainer.classList.add('active');
    chatHeader.setAttribute('aria-pressed', 'true');
    chatToggleIcon.textContent = 'expand_more';
  } else {
    chatContainer.classList.remove('active');
    chatHeader.setAttribute('aria-pressed', 'false');
    chatToggleIcon.textContent = 'expand_less';
  }
});

const chatToggleIcon = document.getElementById('chat-toggle-btn');

chatToggleIcon.addEventListener('click', (e) => {
  e.stopPropagation();
  chatHeader.click();
});

chatInput.addEventListener('input', () => {
  chatSendBtn.disabled = chatInput.value.trim() === '';
});

chatForm.addEventListener('submit', e => {
  e.preventDefault();
  const text = chatInput.value.trim();
  if(!text) return;
  if(!currentUser) {
    showAlert('Silakan login ulang.');
    return;
  }
  const newMsg = {
    senderId: currentUser.uid,
    senderName: currentUser.email || 'Admin',
    text,
    timestamp: new Date().toISOString()
  };
  chatSendBtn.disabled = true;
  chatRef.push(newMsg)
    .then(() => {
      chatInput.value = '';
      chatSendBtn.disabled = true;
      chatInput.focus();
    })
    .catch(err => {
      showError('Gagal mengirim pesan: ' + err.message);
      chatSendBtn.disabled = false;
    });
});

// Filter input event for live filtering tables of items
filterInput.addEventListener('input', () => {
  renderItems('aqua-tech');
  renderItems('aqua-threads');
});
filterClearBtn.addEventListener('click', () => {
  filterInput.value = '';
  renderItems('aqua-tech');
  renderItems('aqua-threads');
});
</script>
</body>
</html>

