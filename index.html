<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATLANTIS CORP - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&family=Material+Icons" rel="stylesheet" />
  <style>
    /* Reset and basics */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #002538 0%, #004661 100%);
      color: #cce7ff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    /* Header */
    header {
      background-color: #003551;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid #006280;
      user-select: none;
      z-index: 1100;
      height: 64px;
      flex-shrink: 0;
    }
    header h1 {
      font-weight: 800;
      font-size: 1.6rem;
      color: #70c9f9;
    }
    header button, #nav-chat-toggle {
      background: #0077b6;
      color: #d0f0fd;
      border: none;
      padding: 8px 20px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1rem;
    }
    header button:hover, #nav-chat-toggle:hover {
      background-color: #0096c7;
    }
    #nav-chat-toggle .material-icons {
      font-size: 20px;
    }
    /* Layout */
    main {
      display: flex;
      flex: 1 1 auto;
      overflow: hidden;
      position: relative;
      z-index: 0;
      height: calc(100vh - 64px);
    }
    /* Sidebar Navigation */
    nav.side-menu {
      width: 280px;
      background-color: #004c73;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      border-right: 2px solid #006280;
      z-index: 0;
      flex-shrink: 0;
    }
    nav.side-menu h2 {
      margin: 0 0 16px;
      font-weight: 700;
      font-size: 1.2rem;
      color: #a3d2f3;
      user-select: none;
      border-bottom: 1px solid #006280;
      padding-bottom: 12px;
    }
    nav.side-menu button.tab-btn {
      background: transparent;
      border: none;
      color: #cce7ff;
      font-size: 1rem;
      font-weight: 600;
      padding: 12px 8px;
      text-align: left;
      cursor: pointer;
      border-radius: 10px;
      margin-bottom: 12px;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    nav.side-menu button.tab-btn.active,
    nav.side-menu button.tab-btn:hover {
      background-color: #0077b6;
      color: #f0f9ff;
      font-weight: 700;
    }
    /* Main Content Area */
    section.content-area {
      flex: 1 1 auto;
      position: relative;
      overflow-y: auto;
      padding: 24px;
      background: #003347;
      border-left: 2px solid #006280;
      display: flex;
      flex-direction: column;
      z-index: 0;
      transition: filter 0.3s ease;
    }
    section.content-area.dimmed {
      filter: blur(3px) brightness(0.7);
      pointer-events: none;
      user-select: none;
    }
    section.content-area > h2 {
      margin-top: 0;
      font-weight: 800;
      font-size: 1.8rem;
      color: #8ed0f9;
      user-select: none;
    }
    /* Filter Section */
    #filter-controls {
      margin-bottom: 24px;
      max-width: 720px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    #filter-input {
      flex: 1 1 300px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #0077b6;
      background: #005a7c;
      color: #ccefff;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      outline-offset: 2px;
      outline-color: #55aaff;
      transition: border-color 0.3s ease;
    }
    #filter-input::placeholder {
      color: #a0c5ef;
    }
    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.95rem;
    }
    thead {
      background-color: #005b8c;
    }
    thead th {
      padding: 10px 12px;
      text-align: left;
      color: #c7e0ff;
      border-bottom: 2px solid #0077b6;
    }
    tbody tr:nth-child(odd) {
      background-color: #00485a;
    }
    tbody tr:nth-child(even) {
      background-color: #005b7b;
    }
    tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid #006ba6;
      color: #cce7ff;
      vertical-align: middle;
      max-width: 220px;
      word-break: break-word;
      white-space: normal;
    }
    tbody tr:hover {
      background-color: #0077b6;
      cursor: default;
    }
    /* Buttons in tables */
    button.action-btn {
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      background-color: #0077b6;
      color: #d0f0fd;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.action-btn:hover:not(:disabled) {
      background-color: #0096c7;
    }
    button.action-btn:disabled {
      background-color: #00465a;
      cursor: not-allowed;
    }
    /* Forms for Add and Update */
    form.item-form {
      max-width: 680px;
      background-color: #00455a;
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 40px;
      box-shadow: 0 0 20px rgba(0,110,160,0.6);
      color: #cde6f1;
    }
    form.item-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      user-select: none;
    }
    form.item-form input[type="text"],
    form.item-form input[type="number"],
    form.item-form textarea,
    form.item-form select {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 20px;
      border-radius: 10px;
      border: 1px solid #0077b6;
      background-color: #005a7c;
      color: #d6eafc;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      resize: vertical;
      outline-offset: 2px;
      outline-color: #55aaff;
      transition: border-color 0.3s ease;
    }
    form.item-form input[type="file"] {
      margin-top: 6px;
      margin-bottom: 20px;
      color: #cce7ff;
    }
    form.item-form input[type="text"]:focus,
    form.item-form input[type="number"]:focus,
    form.item-form textarea:focus,
    form.item-form select:focus {
      border-color: #55aaff;
      background-color: #006791;
    }
    form.item-form button {
      background-color: #0096c7;
      color: #d0f0fd;
      border: none;
      padding: 12px 28px;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
      font-size: 1rem;
      min-height: 44px;
      min-width: 120px;
    }
    form.item-form button:hover:not(:disabled) {
      background-color: #00b0ff;
    }
    form.item-form button:disabled {
      background-color: #005b81;
      cursor: not-allowed;
    }
    /* Image preview styling */
    .image-preview {
      margin-bottom: 16px;
      border-radius: 12px;
      max-width: 180px;
      max-height: 140px;
      object-fit: contain;
      border: 1px solid #0077b6;
      box-shadow: 0 0 8px rgba(0, 127, 255, 0.4);
      user-select: none;
    }

    /* ---CHAT PANEL--- */
    #chat-panel {
      position: fixed;
      top: 64px; /* bawah header */
      right: 0;
      width: 360px;
      height: calc(100% - 64px);
      background-color: #003f61;
      border-left: 2px solid #006280;
      display: flex;
      flex-direction: column;
      z-index: 1200;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 12px rgba(0,0,0,0.5);
      user-select: none;
      font-size: 0.9rem;
      color: #cce7ff;
    }
    #chat-panel.open {
      transform: translateX(0);
    }
    #chat-panel-header {
      height: 56px;
      background-color: #004d7a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #0077b6;
      font-weight: 700;
      font-size: 1.2rem;
      color: #85d2ff;
      user-select: none;
    }
    #chat-panel-header button.close-chat-btn {
      background: transparent;
      border: none;
      color: #85d2ff;
      font-size: 28px;
      cursor: pointer;
      user-select: none;
    }
    /* Chat panel body consists of list users/grups and messages */
    #chat-body {
      flex: 1 1 auto;
      display: flex;
      height: 100%;
      overflow: hidden;
    }
    /* Chat users list/sidebar */
    #chat-users-list {
      width: 140px;
      background-color: #00557a;
      border-right: 1px solid #0077b6;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    #chat-users-list h3 {
      margin: 8px;
      font-weight: 700;
      font-size: 1rem;
      color: #a9d8ff;
      border-bottom: 1px solid #0077b6;
      user-select: none;
    }
    #chat-users-list ul {
      list-style: none;
      margin: 0; padding: 0;
      flex: 1 1 auto;
      overflow-y: auto;
    }
    #chat-users-list li {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #0077b6;
      color: #cce7ff;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #chat-users-list li.selected,
    #chat-users-list li:hover {
      background-color: #0077b6;
      font-weight: 700;
      color: #fff;
    }
    #chat-users-list li .material-icons {
      font-size: 20px;
      color: #b3d8ff;
    }
    /* Chat messages area */
    #chat-messages-area {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      background-color: #015083;
      color: #e0f0ff;
      padding: 12px 16px;
      overflow: hidden;
    }
    #chat-messages-header {
      font-weight: 700;
      margin-bottom: 8px;
      border-bottom: 1px solid #0173b1;
      padding-bottom: 4px;
      user-select: none;
    }
    #chat-messages-list {
      flex: 1 1 auto;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 8px;
      user-select: text;
    }
    #chat-messages-list::-webkit-scrollbar {
      width: 8px;
    }
    #chat-messages-list::-webkit-scrollbar-thumb {
      background-color: #55aaff;
      border-radius: 4px;
    }
    .chat-message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 14px;
      word-wrap: break-word;
      background-color: #0173b1;
      box-shadow: 0 2px 6px rgba(0, 90, 140, 0.7);
      color: #d4e9f7;
      font-size: 0.9rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
      user-select: text;
    }
    .chat-message.self {
      align-self: flex-end;
      background-color: #66b2ff;
      box-shadow: 0 2px 8px rgba(50, 120, 210, 0.8);
      color: #002433;
    }
    .chat-message .sender {
      font-weight: 700;
      color: #b9defb;
      font-size: 0.75rem;
      user-select: none;
    }
    .chat-message .text {
      white-space: pre-wrap;
    }
    .chat-message .meta {
      font-size: 0.7rem;
      color: #a0c9f7;
      text-align: right;
      font-style: italic;
      user-select: none;
    }
    /* Chat input area */
    #chat-input-container {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      flex-shrink: 0;
    }
    #chat-input {
      flex: 1 1 auto;
      border-radius: 20px;
      border: none;
      padding: 12px 16px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      resize: none;
      min-height: 56px;
      max-height: 120px;
      outline-offset: 2px;
      outline-color: #55aaff;
      background-color: #00557a;
      color: #ccefff;
      white-space: pre-wrap;
    }
    #chat-input::placeholder {
      color: #a0c5ef;
    }
    #chat-send-btn {
      background-color: #008ce6;
      color: #cce7ff;
      border: none;
      border-radius: 20px;
      padding: 14px 28px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      min-height: 56px;
      min-width: 100px;
      font-size: 1rem;
    }
    #chat-send-btn:disabled {
      background-color: #004e77;
      cursor: not-allowed;
    }
    #chat-send-btn:hover:not(:disabled) {
      background-color: #00a1ff;
    }
    /* Create group container */
    #create-group-container {
      padding: 12px 16px;
      background-color: #004d7a;
      border-top: 1px solid #0077b6;
      user-select: none;
    }
    #create-group-container label,
    #create-group-container input,
    #create-group-container button {
      display: block;
      width: 100%;
      margin-top: 6px;
    }
    #create-group-container input {
      border-radius: 10px;
      border: 1px solid #0077b6;
      background-color: #005a7c;
      color: #ccefff;
      padding: 8px 12px;
      font-size: 0.9rem;
      outline-offset: 2px;
      outline-color: #55aaff;
      font-family: 'Inter', sans-serif;
    }
    #create-group-container button {
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 14px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      background-color: #0096c7;
      color: #d0f0fd;
      transition: background-color 0.25s ease;
      user-select: none;
    }
    #create-group-container button:hover {
      background-color: #00b0ff;
    }
    /* Responsive */
    @media (max-width: 1100px) {
      nav.side-menu {
        width: 220px;
        padding: 20px 12px;
      }
      section.content-area {
        padding: 16px 18px;
      }
    }
    @media (max-width: 768px) {
      main {
        flex-direction: column;
        overflow: auto;
      }
      nav.side-menu {
        width: 100%;
        border-right: none;
        border-bottom: 2px solid #006280;
        flex-direction: row;
        padding: 12px;
        gap: 8px;
        overflow-x: auto;
      }
      nav.side-menu button.tab-btn {
        flex: none;
        margin-bottom: 0;
        padding: 10px 14px;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      section.content-area {
        border-left: none;
        padding: 16px 12px;
      }
      #chat-panel {
        width: 100%;
        height: 300px;
        top: auto;
        bottom: 0;
        border-left: none;
        border-top: 2px solid #006280;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      #chat-panel.open {
        transform: translateY(0);
      }
      #chat-body {
        flex-direction: column;
      }
      #chat-users-list {
        width: 100%;
        height: 80px;
        border-right: none;
        border-bottom: 1px solid #0077b6;
        flex-direction: row;
        overflow-x: auto;
      }
      #chat-users-list ul {
        flex-direction: row;
      }
      #chat-users-list li {
        border-bottom: none;
        border-right: 1px solid #0077b6;
        padding: 10px 8px;
      }
      #chat-users-list li:last-child {
        border-right: none;
      }
      #chat-messages-area {
        flex: 1 1 auto;
        height: calc(100% - 80px);
      }
      #chat-input-container {
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>

  <header role="banner" aria-label="Header ATLANTIS CORP">
    <h1>ATLANTIS CORP</h1>
    <div style="display:flex; align-items:center; gap:12px;">
      <button id="nav-chat-toggle" aria-label="Buka Tutup Panel Chat">
        <span class="material-icons">chat</span> Chat
      </button>
      <button id="logout-btn" aria-label="Keluar dari akun">Logout</button>
    </div>
  </header>

  <main role="main">
    <nav class="side-menu" aria-label="Navigasi utama">
      <h2>Menu</h2>
      <button id="btn-dashboard" class="tab-btn active" aria-pressed="true" aria-controls="dashboard-section" role="tab">Dashboard</button>
      <button id="btn-update" class="tab-btn" aria-pressed="false" aria-controls="update-section" role="tab">Update Barang</button>
      <button id="btn-create" class="tab-btn" aria-pressed="false" aria-controls="create-section" role="tab">Tambah Barang Baru</button>
    </nav>

    <section class="content-area" tabindex="0">
      <!-- Dashboard display -->
      <section id="dashboard-section" role="tabpanel" aria-labelledby="btn-dashboard">
        <h2>Dashboard - Stok Barang</h2>

        <!-- Filter Controls -->
        <section id="filter-controls" aria-label="Kontrol filter untuk pencarian barang">
          <input type="text" id="filter-input" placeholder="Cari berdasarkan jenis atau model..." aria-label="Filter barang berdasarkan jenis atau model" autocomplete="off" />
        </section>

        <section aria-labelledby="aqua-tech-title">
          <h3 id="aqua-tech-title">Aqua Tech (Perangkat IT)</h3>
          <table aria-describedby="desc-aqua-tech" role="table">
            <caption id="desc-aqua-tech">Daftar barang perangkat IT seperti laptop, tablet, hp, monitor</caption>
            <thead>
              <tr>
                <th scope="col">Kode Barang</th>
                <th scope="col">Jenis Barang</th>
                <th scope="col">Model/Merk</th>
                <th scope="col">Serial Number</th>
                <th scope="col">Spesifikasi</th>
                <th scope="col">Harga Beli</th>
                <th scope="col">Status</th>
                <th scope="col">PIC</th>
                <th scope="col">Gambar</th>
              </tr>
            </thead>
            <tbody id="aqua-tech-table-body">
              <tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>
            </tbody>
          </table>
        </section>

        <section style="margin-top: 40px;" aria-labelledby="aqua-threads-title">
          <h3 id="aqua-threads-title">Aqua Threads (Penjualan Kaos)</h3>
          <table aria-describedby="desc-aqua-threads" role="table">
            <caption id="desc-aqua-threads">Daftar kaos yang dijual</caption>
            <thead>
              <tr>
                <th scope="col">Kode Barang</th>
                <th scope="col">Jenis Barang</th>
                <th scope="col">Model/Merk</th>
                <th scope="col">Serial Number</th>
                <th scope="col">Spesifikasi</th>
                <th scope="col">Harga Beli</th>
                <th scope="col">Status</th>
                <th scope="col">PIC</th>
                <th scope="col">Gambar</th>
              </tr>
            </thead>
            <tbody id="aqua-threads-table-body">
              <tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>
            </tbody>
          </table>
        </section>

        <button id="download-data-btn" style="margin-top:32px; padding:12px 28px; font-weight: 700; border-radius:14px; cursor:pointer; border:none; background:#0096c7; color:#ccefff; user-select:none;">Download Semua Data (Excel)</button>
      </section>

      <!-- Update dashboard -->
      <section id="update-section" role="tabpanel" aria-labelledby="btn-update" hidden>
        <h2>Update Status Barang</h2>
        <section aria-label="Pilih barang yang ingin diupdate" style="max-width:720px;">
          <label for="update-select">Pilih barang:</label>
          <select id="update-select" aria-required="true" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #0077b6; background:#005a7c; color:#ccefff; margin-bottom:16px;"></select>

          <label for="update-status-select">Ubah status menjadi:</label>
          <select id="update-status-select" aria-required="true" style="width:100%; padding:10px; border-radius:10px; border: 1px solid #0077b6; background:#005a7c; color:#ccefff; margin-bottom:22px;">
            <option value="stock">Stock</option>
            <option value="sold">Sudah Terjual</option>
            <option value="lost">Hilang</option>
          </select>

          <button id="update-item-btn" style="background:#00ace6; color:#e0f2ff; border:none; padding:14px 28px; border-radius:14px; font-weight:700; cursor:pointer; user-select:none;">Update Status</button>
        </section>
      </section>

      <!-- Create data new -->
      <section id="create-section" role="tabpanel" aria-labelledby="btn-create" hidden>
        <h2>Tambah Barang Baru</h2>
        <form id="create-form" class="item-form" aria-label="Formulir tambah barang">
          <label for="create-category">Pilih Kategori Barang:</label>
          <select id="create-category" required>
            <option value="" disabled selected>Pilih Aqua Tech atau Aqua Threads</option>
            <option value="aqua-tech">Aqua Tech (Perangkat IT)</option>
            <option value="aqua-threads">Aqua Threads (Kaos)</option>
          </select>

          <label for="create-type">Jenis Barang:</label>
          <input type="text" id="create-type" placeholder="Contoh: Laptop, Kaos" required />

          <label for="create-model">Model / Merk:</label>
          <input type="text" id="create-model" placeholder="Contoh: Dell XPS 13, Kaos Merk X" required />

          <label for="create-serial">Serial Number:</label>
          <input type="text" id="create-serial" placeholder="Nomor Serial" required />

          <label for="create-specs">Detail Spesifikasi:</label>
          <textarea id="create-specs" rows="4" placeholder="RAM, Prosesor, Memory, VGA, dll" required></textarea>

          <label for="create-price">Harga Beli (Rp):</label>
          <input type="number" id="create-price" min="0" step="1000" placeholder="0" required />

          <label for="create-pic">PIC Upload:</label>
          <input type="text" id="create-pic" placeholder="Nama PIC" required />

          <label for="create-image">Upload Gambar Barang (opsional, max 2MB):</label>
          <input type="file" id="create-image" accept="image/*" />

          <div id="preview-container" aria-live="polite" style="margin-bottom:20px;"></div>

          <button type="submit" id="create-submit-btn">Tambah Barang</button>
        </form>
      </section>
    </section>
  </main>

  <!-- Chat Panel -->
  <aside id="chat-panel" aria-label="Panel Chat Admin">
    <div id="chat-panel-header" role="banner">
      <div>Chat Admin</div>
      <button class="close-chat-btn" aria-label="Tutup panel chat">&times;</button>
    </div>
    <div id="chat-body" role="region" aria-live="polite" aria-relevant="additions">
      <nav id="chat-users-list" aria-label="Daftar pengguna dan grup chat">
        <h3>Kontak</h3>
        <ul id="chat-user-items" role="list" tabindex="0" aria-activedescendant="" aria-multiselectable="false">
          <!-- User & Grup chat list items -->
        </ul>
        <div id="create-group-container" aria-label="Buat grup chat baru">
          <label for="new-group-name">Buat Grup Baru:</label>
          <input type="text" id="new-group-name" placeholder="Nama Grup" autocomplete="off" />
          <button id="create-group-btn" type="button">Buat Grup</button>
        </div>
      </nav>
      <section id="chat-messages-area" aria-label="Area pesan chat">
        <header id="chat-messages-header" aria-live="polite" aria-atomic="true">
          Pilih kontak untuk mulai chat
        </header>
        <div id="chat-messages-list" role="log" aria-live="polite" tabindex="0">
          <!-- Chat messages -->
        </div>
        <form id="chat-input-container" aria-label="Formulir kirim pesan" hidden>
          <textarea id="chat-input" aria-label="Input pesan chat" placeholder="Tulis pesan..." rows="3" required></textarea>
          <button id="chat-send-btn" type="submit" disabled>Kirim</button>
        </form>
      </section>
    </div>
  </aside>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
// Firebase config and init
const firebaseConfig = {
  apiKey: "AIzaSyBdKELW2FNsL7H1zB8R765czcDPaSYybdg",
  authDomain: "atlantis-store.firebaseapp.com",
  databaseURL: "https://atlantis-store-default-rtdb.firebaseio.com",
  projectId: "atlantis-store",
  storageBucket: "atlantis-store.appspot.com",
  messagingSenderId: "566295949160",
  appId: "1:566295949160:web:3ad8956c753d2f05a5f0dd",
  measurementId: "G-F5RG09TFCK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

// Elements
const logoutBtn = document.getElementById('logout-btn');
const btnDashboard = document.getElementById('btn-dashboard');
const btnUpdate = document.getElementById('btn-update');
const btnCreate = document.getElementById('btn-create');
const dashboardSection = document.getElementById('dashboard-section');
const updateSection = document.getElementById('update-section');
const createSection = document.getElementById('create-section');
const aquaTechBody = document.getElementById('aqua-tech-table-body');
const aquaThreadsBody = document.getElementById('aqua-threads-table-body');
const downloadBtn = document.getElementById('download-data-btn');
const updateSelect = document.getElementById('update-select');
const updateStatusSelect = document.getElementById('update-status-select');
const updateItemBtn = document.getElementById('update-item-btn');
const createForm = document.getElementById('create-form');
const createCategory = document.getElementById('create-category');
const createType = document.getElementById('create-type');
const createModel = document.getElementById('create-model');
const createSerial = document.getElementById('create-serial');
const createSpecs = document.getElementById('create-specs');
const createPrice = document.getElementById('create-price');
const createImage = document.getElementById('create-image');
const createPic = document.getElementById('create-pic');
const previewContainer = document.getElementById('preview-container');
const filterInput = document.getElementById('filter-input');

// Chat controls
const navChatToggle = document.getElementById('nav-chat-toggle');
const chatPanel = document.getElementById('chat-panel');
const chatPanelCloseBtn = chatPanel.querySelector('.close-chat-btn');
const chatUsersList = document.getElementById('chat-user-items');
const createGroupInput = document.getElementById('new-group-name');
const createGroupBtn = document.getElementById('create-group-btn');
const chatMessagesHeader = document.getElementById('chat-messages-header');
const chatMessagesList = document.getElementById('chat-messages-list');
const chatInputForm = document.getElementById('chat-input-container');
const chatInput = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send-btn');

let chatActive = false;
let currentUser = null;
let itemsCache = { 'aqua-tech': {}, 'aqua-threads': {} };

// Chat State
let chatRooms = {}; // roomId => {name, members, isGroup}
let selectedRoomId = null;

// --- UTILS ---
function sanitize(str) {
  const temp = document.createElement('div');
  temp.textContent = str;
  return temp.innerHTML;
}
function sanitizePlain(str) {
  if(!str) return '';
  return str.toString().replace(/<[^>]*>/g, '').replace(/\n/g, ' ');
}
function generateItemCode() {
  const now = new Date();
  const pad = n => String(n).padStart(2, '0');
  const ymd = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
  const rand = Math.floor(Math.random() * 10000);
  return `ATL-${ymd}-${rand.toString().padStart(4, '0')}`;
}
function showAlert(msg) { alert(msg); }
function showError(msg) { console.error(msg); showAlert(msg); }

// ---- TAB NAVIGATION ----
function activateTab(tabBtn) {
  [btnDashboard, btnUpdate, btnCreate].forEach(btn => {
    const isActive = (btn === tabBtn);
    btn.classList.toggle('active', isActive);
    btn.setAttribute('aria-pressed', isActive.toString());
  });
  dashboardSection.hidden = (tabBtn !== btnDashboard);
  updateSection.hidden = (tabBtn !== btnUpdate);
  createSection.hidden = (tabBtn !== btnCreate);
  if (!dashboardSection.hidden) dashboardSection.focus();
  else if (!updateSection.hidden) updateSection.focus();
  else if (!createSection.hidden) createSection.focus();
}
btnDashboard.addEventListener('click', () => activateTab(btnDashboard));
btnUpdate.addEventListener('click', () => activateTab(btnUpdate));
btnCreate.addEventListener('click', () => activateTab(btnCreate));

// ---- AUTH & LOAD DATA ----
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    console.log("User logged in:", user.uid);
    loadAllDataRealtime();
    loadChatRooms();
  } else {
    currentUser = null;
    window.location.href = "login.html";
  }
});
logoutBtn.addEventListener('click', () => { auth.signOut(); });

// Load barang data realtime
function loadAllDataRealtime() {
  itemsCache['aqua-tech'] = {};
  itemsCache['aqua-threads'] = {};
  aquaTechBody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>';
  aquaThreadsBody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Memuat data...</td></tr>';
  updateSelect.innerHTML = '';

  database.ref('items/aqua-tech').on('value', snap => {
    itemsCache['aqua-tech'] = snap.val() || {};
    renderFilteredItems();
  });
  database.ref('items/aqua-threads').on('value', snap => {
    itemsCache['aqua-threads'] = snap.val() || {};
    renderFilteredItems();
  });
}

// Create table row element helper
function createTableRow(code, item) {
  const tr = document.createElement('tr');
  function addColumn(text) {
    const td = document.createElement('td');
    td.textContent = text;
    return td;
  }
  tr.appendChild(addColumn(code));
  tr.appendChild(addColumn(item.type));
  tr.appendChild(addColumn(item.model));
  tr.appendChild(addColumn(item.serial));
  tr.appendChild(addColumn(sanitizePlain(item.specs)));
  tr.appendChild(addColumn(`Rp${Number(item.price).toLocaleString('id-ID')}`));
  let statusText = '';
  if(item.status === 'stock') statusText = 'Stock';
  else if(item.status === 'sold') statusText = 'Terjual';
  else if(item.status === 'lost') statusText = 'Hilang';
  else statusText = item.status || '';
  const statusTd = document.createElement('td');
  statusTd.textContent = statusText;
  if(statusText === 'Stock') { statusTd.style.color = '#4caf50'; statusTd.style.fontWeight = '700'; }
  else if(statusText === 'Terjual') { statusTd.style.color = '#f44336'; statusTd.style.fontWeight = '700'; }
  else if(statusText === 'Hilang') { statusTd.style.color = '#9e9e9e'; statusTd.style.fontWeight = '700'; }
  tr.appendChild(statusTd);
  tr.appendChild(addColumn(item.pic || 'Tidak ada PIC'));
  const tdImg = document.createElement('td');
  if(item.imageUrl){
    const img = document.createElement('img');
    img.src = item.imageUrl;
    img.alt = `Gambar ${item.type} - ${item.model}`;
    img.className = 'image-preview';
    tdImg.appendChild(img);
  } else {
    tdImg.textContent = 'No Image';
    tdImg.style.color = '#789bb7';
  }
  tr.appendChild(tdImg);
  return tr;
}

// Populate update select dropdown all items
function populateUpdateSelectAll() {
  const allOptions = [];
  ['aqua-tech', 'aqua-threads'].forEach(category => {
    const items = itemsCache[category];
    if(!items) return;
    Object.entries(items).forEach(([code, item]) => {
      allOptions.push({code, label: `[${category.toUpperCase()}] ${code} - ${item.model}`});
    });
  });
  updateSelect.innerHTML = '<option value="" disabled selected>Pilih barang yang akan diupdate</option>';
  allOptions.forEach(opt => {
    const optionElem = document.createElement('option');
    optionElem.value = opt.code;
    optionElem.textContent = opt.label;
    updateSelect.appendChild(optionElem);
  });
}

// Update item status
updateItemBtn.addEventListener('click', () => {
  const selectedCode = updateSelect.value;
  const newStatus = updateStatusSelect.value;
  if(!selectedCode) { showAlert('Pilih barang yang ingin diupdate statusnya.'); return; }
  if(!newStatus) { showAlert('Pilih status baru.'); return; }
  let foundCategory = null;
  if(itemsCache['aqua-tech'] && itemsCache['aqua-tech'][selectedCode]) foundCategory = 'aqua-tech';
  else if(itemsCache['aqua-threads'] && itemsCache['aqua-threads'][selectedCode]) foundCategory = 'aqua-threads';
  if(!foundCategory) { showAlert('Barang tidak ditemukan.'); return; }
  database.ref(`items/${foundCategory}/${selectedCode}/status`).set(newStatus)
  .then(() => {
    showAlert(`Status barang ${selectedCode} berhasil diupdate menjadi ${newStatus}.`);
    updateSelect.value = '';
    updateStatusSelect.value = '';
  })
  .catch(err => { showError('Gagal update status: ' + err.message); });
});

// Image preview create form
createImage.addEventListener('change', () => {
  previewContainer.innerHTML = '';
  if(createImage.files.length === 0) return;
  const file = createImage.files[0];
  if(file.size > 2*1024*1024) {
    showAlert('Ukuran gambar maksimal 2 MB.');
    createImage.value = '';
    return;
  }
  const img = document.createElement('img');
  img.className = 'image-preview';
  img.alt = 'Preview Gambar Barang Baru';
  img.src = URL.createObjectURL(file);
  previewContainer.appendChild(img);
});

// Create new item submit
createForm.addEventListener('submit', e => {
  e.preventDefault();
  const category = createCategory.value;
  const type = createType.value.trim();
  const model = createModel.value.trim();
  const serial = createSerial.value.trim();
  const specs = createSpecs.value.trim();
  const priceRaw = createPrice.value.trim();
  const price = Number(priceRaw);
  const picValue = createPic.value.trim();
  if(!category || !type || !model || !serial || !specs || !priceRaw || isNaN(price) || price < 0 || !picValue) {
    showAlert('Mohon isi semua data dengan benar, termasuk PIC.');
    return;
  }
  const submitBtn = createForm.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Menyimpan...';
  const itemCode = generateItemCode();
  const newItem = {
    type, model, serial, specs, price,
    status:'stock',
    imageUrl:null,
    createdAt: new Date().toISOString(),
    pic: picValue
  };
  if(createImage.files.length > 0) {
    const file = createImage.files[0];
    const ext = file.name.split('.').pop();
    const storageRef = storage.ref(`item-images/${itemCode}.${ext}`);
    storageRef.put(file)
      .then(snapshot => snapshot.ref.getDownloadURL())
      .then(url => {
        newItem.imageUrl = url;
        return database.ref(`items/${category}/${itemCode}`).set(newItem);
      })
      .then(() => {
        showAlert(`Barang baru dengan kode ${itemCode} berhasil ditambahkan.`);
        createForm.reset();
        previewContainer.innerHTML = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      })
      .catch(err => {
        showError('Gagal menambahkan barang: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      });
  } else {
    database.ref(`items/${category}/${itemCode}`).set(newItem)
      .then(() => {
        showAlert(`Barang baru dengan kode ${itemCode} berhasil ditambahkan.`);
        createForm.reset();
        previewContainer.innerHTML = '';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      })
      .catch(err => {
        showError('Gagal menambahkan barang: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Tambah Barang';
      });
  }
});

// Download as Excel
downloadBtn.addEventListener('click', () => {
  const workbook = XLSX.utils.book_new();
  function addSheetFromItems(category, sheetName) {
    const items = itemsCache[category];
    if(!items) return;
    const rows = [];
    rows.push(['Kode Barang','Kategori','Jenis Barang','Model/Merk','Serial Number','Spesifikasi','Harga Beli (Rp)','Status','PIC','Tanggal Dibuat']);
    Object.entries(items).forEach(([code, item]) => {
      rows.push([
        code,
        category === 'aqua-tech' ? 'Aqua Tech' : 'Aqua Threads',
        item.type,
        item.model,
        item.serial,
        item.specs,
        item.price,
        item.status,
        item.pic || '',
        item.createdAt ? new Date(item.createdAt).toLocaleString('id-ID') : ''
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(workbook, ws, sheetName);
  }
  addSheetFromItems('aqua-tech', 'AquaTech');
  addSheetFromItems('aqua-threads', 'AquaThreads');
  XLSX.writeFile(workbook, 'AtlantisCorp_DataBarang_'+new Date().toISOString().slice(0,10)+'.xlsx');
});

// Filter render helper
function renderFilteredItems() {
  const filterValue = filterInput.value.toLowerCase();
  ['aqua-tech','aqua-threads'].forEach(category => {
    const tbody = (category === 'aqua-tech') ? aquaTechBody : aquaThreadsBody;
    const items = itemsCache[category];
    tbody.innerHTML = '';
    if (!items || Object.keys(items).length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Tidak ada data.</td></tr>';
      return;
    }
    let filteredCount = 0;
    Object.entries(items).forEach(([code, item]) => {
      if(item.type.toLowerCase().includes(filterValue) || item.model.toLowerCase().includes(filterValue)){
        tbody.appendChild(createTableRow(code, item));
        filteredCount++;
      }
    });
    if(filteredCount === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="color:#ff6a6a; text-align:center;">Tidak ada data yang sesuai filter.</td></tr>';
    }
  });
  populateUpdateSelectAll();
}
filterInput.addEventListener('input', renderFilteredItems);

// --- CHAT ROOM MANAGEMENT ---
// Chat database refs
const chatRoomsRef = database.ref('chatRooms');
const messagesRef = database.ref('messages');

// Load chat rooms where current user is member
function loadChatRooms() {
  chatRoomsRef.orderByChild(`members/${currentUser.uid}`).equalTo(true).on('value', snap=>{
    chatRooms = snap.val() || {};
    renderChatRooms();
  });
}

function renderChatRooms() {
  chatUsersList.innerHTML = '';
  const rooms = Object.entries(chatRooms);
  if(rooms.length === 0){
    const li = document.createElement('li');
    li.textContent = 'Tidak ada chat aktif';
    li.style.userSelect = 'none';
    chatUsersList.appendChild(li);
    clearChatArea();
    return;
  }
  rooms.forEach(([roomId, room]) => {
    const li = document.createElement('li');
    li.setAttribute('role','option');
    li.setAttribute('tabindex', '0');
    li.dataset.roomId = roomId;
    // Icon for group or user
    const icon = document.createElement('span');
    icon.className = 'material-icons';
    icon.textContent = room.isGroup ? 'group' : 'person';
    li.appendChild(icon);
    // Show room name or for 1-on-1 show other user email
    let name = room.name;
    if(!room.isGroup && room.name === 'Direct Chat'){
      // find other member id
      const membersIds = Object.keys(room.members || {});
      const otherId = membersIds.find(id => id !== currentUser.uid);
      if(otherId){
        // fetch other user email - naive for demo, here just show truncated uid
        name = 'User: '+otherId.substring(0,8);
      }
    }
    const textNode = document.createTextNode(name);
    li.appendChild(textNode);
    if(selectedRoomId === roomId) {
      li.classList.add('selected');
      chatUsersList.setAttribute('aria-activedescendant', li.id || '');
    }
    li.addEventListener('click', () => selectChatRoom(roomId));
    li.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectChatRoom(roomId);
      }
    });
    chatUsersList.appendChild(li);
  });
}

// Clear chat message area
function clearChatArea(){
  chatMessagesHeader.textContent = 'Pilih kontak untuk mulai chat';
  chatMessagesList.innerHTML = '';
  chatInputForm.hidden = true;
  chatInput.value = '';
  chatSendBtn.disabled = true;
  selectedRoomId = null;
}

// Select chat room to view messages
function selectChatRoom(roomId) {
  if(selectedRoomId === roomId) return;
  selectedRoomId = roomId;
  renderChatRooms();
  loadChatMessages(roomId);
}

// Load chat messages for selected room
function loadChatMessages(roomId) {
  chatMessagesList.innerHTML = '';
  chatInputForm.hidden = false;
  chatInput.value = '';
  chatSendBtn.disabled = true;
  const room = chatRooms[roomId];
  if(room) {
    chatMessagesHeader.textContent = room.name || (room.isGroup ? 'Grup Chat' : 'Chat Pribadi');
  } else {
    chatMessagesHeader.textContent = 'Chat tidak ditemukan';
    chatInputForm.hidden = true;
    return;
  }
  messagesRef.child(roomId).off(); // Remove previous listener if any
  messagesRef.child(roomId).limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    if(!msg) return;
    addChatMessage(msg, msg.senderId === currentUser.uid);
  });
  chatMessagesList.scrollTop = chatMessagesList.scrollHeight;
}

// Add a chat message element to message list
function addChatMessage(msg, isSelf) {
  const div = document.createElement('div');
  div.className = 'chat-message';
  if(isSelf) div.classList.add('self');
  const senderDiv = document.createElement('div');
  senderDiv.className = 'sender';
  senderDiv.textContent = msg.senderName || 'Admin';
  div.appendChild(senderDiv);
  const textDiv = document.createElement('div');
  textDiv.className = 'text';
  textDiv.textContent = msg.text;
  div.appendChild(textDiv);
  const meta = document.createElement('div');
  meta.className = 'meta';
  const time = new Date(msg.timestamp);
  meta.textContent = time.toLocaleTimeString('id-ID');
  div.appendChild(meta);
  chatMessagesList.appendChild(div);
  chatMessagesList.scrollTop = chatMessagesList.scrollHeight;
}

// Send chat message handler
chatInputForm.addEventListener('submit', e => {
  e.preventDefault();
  if(!selectedRoomId){
    showAlert('Pilih kontak/chat room dulu.');
    return;
  }
  const text = chatInput.value.trim();
  if(!text) return;
  if(!currentUser){
    showAlert('Silakan login ulang.');
    return;
  }
  const newMsg = {
    senderId: currentUser.uid,
    senderName: currentUser.email || 'Admin',
    text,
    timestamp: new Date().toISOString()
  };
  chatSendBtn.disabled = true;
  messagesRef.child(selectedRoomId).push(newMsg)
    .then(() => {
      chatInput.value = '';
      chatSendBtn.disabled = true;
      chatInput.focus();
    })
    .catch(err => {
      showError('Gagal mengirim pesan: ' + err.message);
      chatSendBtn.disabled = false;
    });
});
chatInput.addEventListener('input', () => {
  chatSendBtn.disabled = chatInput.value.trim() === '';
});

// Toggle chat panel open/close
navChatToggle.addEventListener('click', ()=>{
  chatPanel.classList.toggle('open');
  // If open, dim main content
  document.querySelector('.content-area').classList.toggle('dimmed', chatPanel.classList.contains('open'));
});
chatPanelCloseBtn.addEventListener('click', ()=>{
  chatPanel.classList.remove('open');
  document.querySelector('.content-area').classList.remove('dimmed');
});

// Create group chat
createGroupBtn.addEventListener('click', () => {
  const name = createGroupInput.value.trim();
  if(name.length < 3){
    showAlert('Nama grup minimal 3 karakter.');
    return;
  }
  if(!currentUser) {
    showAlert('Silakan login ulang.');
    return;
  }
  // Generate new room id
  const roomId = database.ref('chatRooms').push().key;
  if(!roomId){
    showError('Gagal membuat grup.');
    return;
  }
  const newRoom = {
    name,
    isGroup: true,
    members: { [currentUser.uid]: true }
  };
  chatRoomsRef.child(roomId).set(newRoom)
    .then(() => {
      createGroupInput.value = '';
      selectChatRoom(roomId);
      showAlert('Grup chat berhasil dibuat.');
    })
    .catch(err => showError('Gagal membuat grup: ' + err.message));
});

// --- Barang Filtering: On filter input ---
filterInput.addEventListener('input', renderFilteredItems);

// --- Load Data Realtime for Filtering ---
function renderFilteredItems() {
  const filterValue = filterInput.value.toLowerCase();
  ['aqua-tech','aqua-threads'].forEach(category => {
    const tbody = (category === 'aqua-tech') ? aquaTechBody : aquaThreadsBody;
    const items = itemsCache[category];
    tbody.innerHTML = '';
    if(!items || Object.keys(items).length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="color:#8dbfef; text-align:center;">Tidak ada data.</td></tr>';
      return;
    }
    let filteredCount = 0;
    Object.entries(items).forEach(([code, item]) => {
      if(item.type.toLowerCase().includes(filterValue) || item.model.toLowerCase().includes(filterValue)){
        tbody.appendChild(createTableRow(code, item));
        filteredCount++;
      }
    });
    if(filteredCount === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="color:#ff6a6a; text-align:center;">Tidak ada data yang sesuai filter.</td></tr>';
    }
  });
  populateUpdateSelectAll();
}

</script>
</body>
</html>

